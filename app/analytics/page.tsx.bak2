"use client";

// ====================================================
// PROTECCIÃ“N CONTRA RENDER EN SERVER
// ====================================================
const [isClient, setIsClient] = useState(false);
useEffect(() => {
  setIsClient(true);
}, []);
// ====================================================



export const dynamic = 'force-dynamic';
import { useState, useEffect, useCallback, memo } from "react";
import { AreaChart, Area, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from "recharts";
import { TrendingUp, TrendingDown, Users, Activity, DollarSign, Eye, RefreshCw, ChevronRight, Home, Loader2, AlertCircle, Zap, Target, BarChart3, ShoppingCart } from "lucide-react";
import Link from "next/link";
import { useTheme } from "@/components/providers/ThemeProvider";
import Sidebar from "@/components/layout/Sidebar";
import { analyticsAPI, cancelAllRequests } from "@/lib/api";
import type { AnalyticsOverview, PerformanceChartData, MetricValue, KPI, CampaignPerformance } from "@/lib/api";

const COLORS = ["#8b5cf6", "#10b981", "#f59e0b", "#ef4444", "#06b6d4", "#ec4899"];

interface PerformanceChartResponse {
  data: PerformanceChartData[];
  total: number;
  average: number;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMOIZED COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MetricCardProps {
  title: string;
  metric: MetricValue;
  icon: any;
  format?: "number" | "currency" | "percent";
  colors: { bgCard: string; borderColor: string; textPrimary: string; textMuted: string; accentPrimary: string };
}

const MetricCard = memo(function MetricCard({ title, metric, icon: Icon, format = "number", colors }: MetricCardProps) {
  const { bgCard, borderColor, textPrimary, textMuted, accentPrimary } = colors;
  const isPositive = metric.trend === "up";
  const formatValue = (v: number) => {
    if (format === "currency") return "\$" + v.toLocaleString();
    if (format === "percent") return v + "%";
    return v.toLocaleString();
  };
  if (!isClient) {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
    </div>
  );
}

return (
    <div className="p-5 rounded-xl" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor }}>
      <div className="flex items-center justify-between mb-3">
        <span className="text-sm" style={{ color: textMuted }}>{title}</span>
        <div className="p-2 rounded-lg" style={{ backgroundColor: accentPrimary + "15" }}>
          <Icon className="w-4 h-4" style={{ color: accentPrimary }} />
        </div>
      </div>
      <div className="text-2xl font-bold" style={{ color: textPrimary }}>{formatValue(metric.current) : []}</div>
      <div className="flex items-center gap-1 mt-1">
        {isPositive ? <TrendingUp className="w-3 h-3 text-green-500" /> : <TrendingDown className="w-3 h-3 text-red-500" />}
        <span className={"text-xs font-medium " + (isPositive ? "text-green-500" : "text-red-500") : []}>{Math.abs(metric.change) : []}%</span>
        <span className="text-xs" style={{ color: textMuted }}>vs anterior</span>
      </div>
    </div>
  );
});

interface TrendChartProps {
  data: { date: string; value: number }[];
  colors: { bgCard: string; borderColor: string; textPrimary: string; textMuted: string; accentPrimary: string; bgPrimary: string };
  metric: string;
  onMetricChange: (m: string) => void;
  total: number;
  average: number;
}

const TrendChart = memo(function TrendChart({ data, colors, metric, onMetricChange, total, average }: TrendChartProps) {
  const { bgCard, borderColor, textPrimary, textMuted, accentPrimary, bgPrimary } = colors;
  return (
    <div className="p-6 rounded-xl" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor }}>
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-semibold" style={{ color: textPrimary }}>Tendencia: {metric}</h3>
        <select value={metric} onChange={(e) => onMetricChange(e.target.value) : []} className="px-2 py-1 rounded text-sm" style={{ backgroundColor: bgPrimary, border: "1px solid " + borderColor, color: textPrimary }}>
          <option value="sessions">Sesiones</option>
          <option value="users">Usuarios</option>
          <option value="revenue">Revenue</option>
          <option value="events">Eventos</option>
        </select>
      </div>
      <div className="h-64">
        <ResponsiveContainer width="100%" height="100%">
          <AreaChart data={data}>
            <defs>
              <linearGradient id="colorMetric" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor={accentPrimary} stopOpacity={0.3}/>
                <stop offset="95%" stopColor={accentPrimary} stopOpacity={0}/>
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke={borderColor} />
            <XAxis dataKey="date" stroke={textMuted} fontSize={12} tickFormatter={(v) => v.slice(5) : []} />
            <YAxis stroke={textMuted} fontSize={12} />
            <Tooltip contentStyle={{ backgroundColor: bgCard, border: "1px solid " + borderColor, borderRadius: 8, color: textPrimary }} />
            <Area type="monotone" dataKey="value" stroke={accentPrimary} fillOpacity={1} fill="url(#colorMetric)" strokeWidth={2} />
          </AreaChart>
        </ResponsiveContainer>
      </div>
      <div className="flex items-center justify-between mt-4 pt-4" style={{ borderTop: "1px solid " + borderColor }}>
        <div><span className="text-sm" style={{ color: textMuted }}>Total:</span><span className="ml-2 font-semibold" style={{ color: textPrimary }}>{total.toLocaleString() : []}</span></div>
        <div><span className="text-sm" style={{ color: textMuted }}>Promedio:</span><span className="ml-2 font-semibold" style={{ color: textPrimary }}>{Math.round(average).toLocaleString() : []}</span></div>
      </div>
    </div>
  );
});

interface CampaignBarChartProps {
  campaigns: CampaignPerformance[];
  colors: { bgCard: string; borderColor: string; textPrimary: string; textMuted: string; accentPrimary: string };
}

const CampaignBarChart = memo(function CampaignBarChart({ campaigns, colors }: CampaignBarChartProps) {
  const { bgCard, borderColor, textPrimary, textMuted, accentPrimary } = colors;
  return (
    <div className="p-6 rounded-xl" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor }}>
      <h3 className="font-semibold mb-4" style={{ color: textPrimary }}>Performance por CampaÃ±a</h3>
      <div className="h-64">
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={campaigns.slice(0, 5) : []} layout="vertical">
            <CartesianGrid strokeDasharray="3 3" stroke={borderColor} />
            <XAxis type="number" stroke={textMuted} fontSize={12} />
            <YAxis dataKey="name" type="category" stroke={textMuted} fontSize={11} width={100} tickFormatter={(v: string) => v.length > 12 ? v.slice(0,12) + "..." : v} />
            <Tooltip contentStyle={{ backgroundColor: bgCard, border: "1px solid " + borderColor, borderRadius: 8 }} />
            <Bar dataKey="opened" fill="#10b981" name="Abiertos" radius={[0, 4, 4, 0]} />
            <Bar dataKey="clicked" fill={accentPrimary} name="Clicks" radius={[0, 4, 4, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function AnalyticsDashboardPage() {
  const { theme } = useTheme();
  const isLight = theme?.isLight;
  
  const [overview, setOverview] = useState<AnalyticsOverview | null>(null);
  const [chartData, setChartData] = useState<PerformanceChartData[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [period, setPeriod] = useState("30d");


  // Helper para obtener el valor basado en la mÃ©trica seleccionada
  const getMetricValue = useCallback((item: PerformanceChartData, metric: string) => {
    switch (metric) {
      case "sessions": return item.sessions;
      case "users": return item.users;
      case "revenue": return item.revenue;
      case "events": return item.events;
      default: return item.sessions;
    }
  }, []);
  const [selectedMetric, setSelectedMetric] = useState("sessions");

  const colors = {
    bgPrimary: isLight ? "#f8fafc" : theme?.colors?.bgPrimary || "#0F172A",
    bgSecondary: isLight ? "#ffffff" : theme?.colors?.bgSecondary || "#111827",
    bgCard: isLight ? "#ffffff" : theme?.colors?.bgCard || "rgba(30,41,59,0.5)",
    textPrimary: isLight ? "#0f172a" : theme?.colors?.textPrimary || "#f1f5f9",
    textMuted: isLight ? "#64748b" : theme?.colors?.textMuted || "#64748b",
    borderColor: isLight ? "rgba(0,0,0,0.1)" : theme?.colors?.borderPrimary || "rgba(255,255,255,0.1)",
    accentPrimary: theme?.colors?.accentPrimary || "#8b5cf6",
  };

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const [ov, perf] = await Promise.all([
        analyticsAPI.getOverview("default", period),
        analyticsAPI.getPerformance(selectedMetric, period, "default")
      ]);
      setOverview(ov);
      setChartData(perf);
    } catch (err) {
      if (err instanceof Error && err.message === "Request cancelled") return;
      setError("Error al cargar datos");
      console.error(err);
    } finally {
      setLoading(false);
    }
  }, [period, selectedMetric]);

  useEffect(() => {
    fetchData();
    return () => cancelAllRequests();
  }, [fetchData]);

  if (loading && !overview) {
    return (
      <div className="flex min-h-screen" style={{ backgroundColor: colors.bgPrimary }}>
        <Sidebar />
        <main className="flex-1 ml-80 flex items-center justify-center">
          <div className="text-center">
            <Loader2 className="w-12 h-12 animate-spin mx-auto mb-4" style={{ color: colors.accentPrimary }} />
            <p style={{ color: colors.textMuted }}>Cargando analytics...</p>
          </div>
        </main>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen" style={{ backgroundColor: colors.bgPrimary }}>
      <Sidebar />
      <main className="flex-1 ml-80">
        <header className="sticky top-0 z-40 backdrop-blur-xl" style={{ backgroundColor: colors.bgSecondary + "ee", borderBottom: "1px solid " + colors.borderColor }}>
          <div className="px-6 py-4">
            <div className="flex items-center gap-2 mb-3">
              <Link href="/" className="flex items-center gap-1 text-sm" style={{ color: colors.textMuted }}><Home className="w-4 h-4" /> Inicio</Link>
              <ChevronRight className="w-4 h-4" style={{ color: colors.textMuted }} />
              <span className="text-sm font-medium" style={{ color: colors.accentPrimary }}>Analytics</span>
            </div>
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold flex items-center gap-2" style={{ color: colors.textPrimary }}>
                  <BarChart3 className="w-6 h-6" style={{ color: colors.accentPrimary }} /> Analytics Dashboard
                </h1>
                <p className="text-sm" style={{ color: colors.textMuted }}>
                  {overview?.data_source === "database" ? "ğŸŸ¢ Base de datos" : "ğŸŸ¡ API"} â€¢ {overview ? new Date(overview.generated_at || Date.now()).toLocaleTimeString() : "..."}
                </p>
              </div>
              <div className="flex items-center gap-3">
                <select value={period} onChange={(e) => setPeriod(e.target.value) : []} className="px-3 py-2 rounded-lg text-sm" style={{ backgroundColor: colors.bgCard, border: "1px solid " + colors.borderColor, color: colors.textPrimary }}>
                  <option value="24h">24 horas</option>
                  <option value="7d">7 dÃ­as</option>
                  <option value="30d">30 dÃ­as</option>
                  <option value="90d">90 dÃ­as</option>
                </select>
                <button onClick={fetchData} disabled={loading} className="px-4 py-2 rounded-lg text-sm flex items-center gap-2" style={{ backgroundColor: colors.accentPrimary + "20", color: colors.accentPrimary }}>
                  <RefreshCw className={"w-4 h-4 " + (loading ? "animate-spin" : "") : []} /> Actualizar
                </button>
              </div>
            </div>
          </div>
        </header>

        <div className="p-6">
          {error && (
            <div className="mb-6 p-4 rounded-lg bg-red-500/10 border border-red-500/20 flex items-center gap-3">
              <AlertCircle className="w-5 h-5 text-red-500" />
              <span className="text-red-500">{error}</span>
              <button onClick={fetchData} className="ml-auto px-3 py-1 rounded text-sm bg-red-500 text-white">Reintentar</button>
            </div>
          ) : []}

          {overview && (
            <>
              <div className="grid grid-cols-4 gap-4 mb-6">
                <MetricCard title="MAU" metric={overview.mau} icon={Users} colors={colors} />
                <MetricCard title="DAU" metric={overview.dau} icon={Activity} colors={colors} />
                <MetricCard title="Sesiones" metric={overview.daily_sessions} icon={Eye} colors={colors} />
                <MetricCard title="Revenue" metric={overview.total_revenue} icon={DollarSign} format="currency" colors={colors} />
              </div>

              <div className="grid grid-cols-2 gap-6 mb-6">
                <TrendChart data={chartData?.map(d => ({ date: d.date, value: d.sessions })) : []} colors={colors} metric={selectedMetric} onMetricChange={setSelectedMetric} total={chartData.reduce((s, i) => s + (i.sessions || 0), 0) : []} average={Math.round(chartData.reduce((s, i) => s + (i.sessions || 0), 0) / (chartData.length || 1)) : []} />
                <CampaignBarChart campaigns={overview.top_campaigns} colors={colors} />
              </div>

              <div className="grid grid-cols-3 gap-6">
                {/* KPIs */}
                <div className="p-6 rounded-xl" style={{ backgroundColor: colors.bgCard, border: "1px solid " + colors.borderColor }}>
                  <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: colors.textPrimary }}>
                    <Target className="w-5 h-5" style={{ color: colors.accentPrimary }} /> KPIs
                  </h3>
                  <div className="space-y-4">
                    {overview?.kpis?.map((kpi, index) => {
                      const progress = (kpi.value / kpi.target) * 100;
                      return (
                        <div key={index}>
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-sm" style={{ color: colors.textPrimary }}>{kpi.name}</span>
                            <span className="text-sm font-medium" style={{ color: progress >= 100 ? "#10b981" : colors.accentPrimary }}>
                              {kpi.unit === "USD" ? "\$" : ""}{kpi.value.toLocaleString() : []}{kpi.unit === "%" ? "%" : ""} / {kpi.target.toLocaleString() : []}
                            </span>
                          </div>
                          <div className="h-2 rounded-full overflow-hidden" style={{ backgroundColor: colors.borderColor }}>
                            <div className="h-full rounded-full" style={{ width: Math.min(progress, 100) + "%", backgroundColor: progress >= 100 ? "#10b981" : colors.accentPrimary }} />
                          </div>
                        </div>
                      );
                    }) : []}
                  </div>
                </div>

                {/* Funnel */}
                <div className="p-6 rounded-xl" style={{ backgroundColor: colors.bgCard, border: "1px solid " + colors.borderColor }}>
                  <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: colors.textPrimary }}>
                    <Zap className="w-5 h-5" style={{ color: colors.accentPrimary }} /> Funnel
                  </h3>
                  <div className="space-y-3">
                    {[
                      { label: "Clicks", value: overview?.top_campaigns?.reduce((a, c) => a + c.clicks, 0), color: "#64748b" },
                      { label: "Conversiones", value: overview?.top_campaigns?.reduce((a, c) => a + c.conversions, 0), color: "#06b6d4" },
                      { label: "Revenue", value: overview?.top_campaigns?.reduce((a, c) => a + c.revenue, 0), color: "#10b981" },
                      { label: "ROI", value: overview?.top_campaigns?.length, color: colors.accentPrimary },
                      { label: "Conversiones", value: overview?.top_campaigns?.reduce((a, c) => a + c.conversions, 0), color: "#f59e0b" },
                    ].map((step, i, arr) => {
                      const maxVal = arr[0].value || 1;
                      const pct = Math.round((step.value / maxVal) * 100);
                      return (
                        <div key={step.label}>
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-sm" style={{ color: colors.textMuted }}>{step.label}</span>
                            <span className="text-sm font-medium" style={{ color: colors.textPrimary }}>{step.value.toLocaleString() : []} ({pct}%)</span>
                          </div>
                          <div className="h-5 rounded" style={{ backgroundColor: colors.borderColor }}>
                            <div className="h-full rounded" style={{ width: pct + "%", backgroundColor: step.color, minWidth: "20px" }} />
                          </div>
                        </div>
                      );
                    }) : []}
                  </div>
                </div>

                {/* Top Campaigns */}
                <div className="p-6 rounded-xl" style={{ backgroundColor: colors.bgCard, border: "1px solid " + colors.borderColor }}>
                  <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: colors.textPrimary }}>
                    <ShoppingCart className="w-5 h-5" style={{ color: colors.accentPrimary }} /> Top Campaigns
                  </h3>
                  <div className="space-y-3">
                    {overview?.top_campaigns?.slice(0, 5).map((c, i) => (
                      <div key={c.id} className="flex items-center gap-3 p-2 rounded-lg" style={{ backgroundColor: colors.bgPrimary }}>
                        <div className="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: COLORS[i % COLORS.length] + "20", color: COLORS[i % COLORS.length] }}>{i + 1}</div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium truncate" style={{ color: colors.textPrimary }}>{c.name}</p>
                          <p className="text-xs" style={{ color: colors.textMuted }}>{c.clicks.toLocaleString() : []} clicks</p>
                        </div>
                        <p className="text-sm font-semibold text-green-500">\</p>
                      </div>
                    )) : []}
                  </div>
                  <Link href="/marketing/campaigns" className="mt-4 w-full py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2" style={{ backgroundColor: colors.accentPrimary + "10", color: colors.accentPrimary }}>
                    Ver todas <ChevronRight className="w-4 h-4" />
                  </Link>
                </div>
              </div>

              <div className="mt-6 flex items-center justify-center gap-2 text-xs" style={{ color: colors.textMuted }}>
                <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                <span>Dashboard en vivo â€¢ {overview.active_campaigns} campaÃ±as activas</span>
              </div>
            </>
          ) : []}
        </div>
      </main>
    </div>
  );
}





