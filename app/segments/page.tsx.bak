"use client";

// ====================================================
// PROTECCIÃ“N CONTRA RENDER EN SERVER
// ====================================================
const [isClient, setIsClient] = useState(false);
useEffect(() => {
  setIsClient(true);
}, []);
// ====================================================



export const dynamic = 'force-dynamic';
import { useState, useEffect } from "react";
import { Plus, Search, Filter, Eye, Edit2, Trash2, Star, StarOff, ChevronRight, Home, MoreHorizontal, Users, Calendar, Tag } from "lucide-react";
import Link from "next/link";
import { useTheme } from "@/components/providers/ThemeProvider";
import Sidebar from "@/components/layout/Sidebar";

interface Segment {
  id: string;
  name: string;
  description: string;
  status: "active" | "draft" | "archived";
  userCount: number;
  percentage: number;
  starred: boolean;
  tags: string[];
  lastEditedBy: string;
  lastEdited: string;
  createdAt: string;
}

const MOCK_SEGMENTS: Segment[] = [
  { id: "1", name: "Non-Adopters", description: "Users who haven't used core features", status: "active", userCount: 342, percentage: 28.5, starred: true, tags: ["Engagement", "Onboarding"], lastEditedBy: "Braze Demo", lastEdited: "Jan 5, 2026", createdAt: "Dec 1, 2025" },
  { id: "2", name: "New Users", description: "Users who signed up in the last 7 days", status: "active", userCount: 156, percentage: 13.0, starred: false, tags: ["New"], lastEditedBy: "Braze Demo", lastEdited: "Jan 5, 2026", createdAt: "Nov 15, 2025" },
  { id: "3", name: "Lapsed Users", description: "Users inactive for 30+ days", status: "active", userCount: 89, percentage: 7.4, starred: false, tags: ["Re-engagement"], lastEditedBy: "Braze Demo", lastEdited: "Jan 5, 2026", createdAt: "Oct 20, 2025" },
  { id: "4", name: "Active Frequent Users", description: "Users with 10+ sessions this month", status: "active", userCount: 423, percentage: 35.2, starred: true, tags: ["Power Users", "Retention"], lastEditedBy: "Braze Demo", lastEdited: "Jan 5, 2026", createdAt: "Sep 1, 2025" },
  { id: "5", name: "High Value Customers", description: "Users with LTV > $100", status: "active", userCount: 67, percentage: 5.6, starred: true, tags: ["Revenue", "VIP"], lastEditedBy: "Braze Demo", lastEdited: "Jan 4, 2026", createdAt: "Aug 15, 2025" },
  { id: "6", name: "Cart Abandoners", description: "Users who abandoned cart in last 7 days", status: "draft", userCount: 234, percentage: 19.5, starred: false, tags: ["E-commerce"], lastEditedBy: "Braze Demo", lastEdited: "Jan 3, 2026", createdAt: "Jan 1, 2026" },
  { id: "7", name: "Email Openers", description: "Users who opened emails in last 30 days", status: "active", userCount: 567, percentage: 47.2, starred: false, tags: ["Email", "Engagement"], lastEditedBy: "Braze Demo", lastEdited: "Jan 2, 2026", createdAt: "Dec 15, 2025" },
];

export default function SegmentsListPage() {
  const { theme } = useTheme();
  const isLight = theme?.isLight;
  
  const [segments, setSegments] = useState<Segment[]>(MOCK_SEGMENTS);
  const [search, setSearch] = useState("");
  const [selectedTag, setSelectedTag] = useState("All Tags");
  const [showStarredOnly, setShowStarredOnly] = useState(false);

  const bgPrimary = isLight ? "#f8fafc" : theme?.colors?.bgPrimary || "#0F172A";
  const bgSecondary = isLight ? "#ffffff" : theme?.colors?.bgSecondary || "#111827";
  const bgCard = isLight ? "#ffffff" : theme?.colors?.bgCard || "rgba(30,41,59,0.5)";
  const textPrimary = isLight ? "#0f172a" : theme?.colors?.textPrimary || "#f1f5f9";
  const textMuted = isLight ? "#64748b" : theme?.colors?.textMuted || "#64748b";
  const borderColor = isLight ? "rgba(0,0,0,0.1)" : theme?.colors?.borderPrimary || "rgba(255,255,255,0.1)";
  const accentPrimary = theme?.colors?.accentPrimary || "#8b5cf6";

  const allTags = ["All Tags", ...new Set(segments.flatMap(s => s.tags))];
  
  const filteredSegments = segments.filter(s => {
    if (search && !s.name.toLowerCase().includes(search.toLowerCase())) return false;
    if (selectedTag !== "All Tags" && !s.tags.includes(selectedTag)) return false;
    if (showStarredOnly && !s.starred) return false;
    return true;
  });

  const toggleStar = (id: string) => {
    setSegments(segments?.map(s => s.id === id ? { ...s, starred: !s.starred } : s));
  };

  if (!isClient) {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
    </div>
  );
}

return (
    <div className="flex min-h-screen" style={{ backgroundColor: bgPrimary }}>
      <Sidebar />
      <main className="flex-1 ml-80">
        <header className="sticky top-0 z-40 backdrop-blur-xl" style={{ backgroundColor: bgSecondary + "ee", borderBottom: "1px solid " + borderColor }}>
          <div className="px-6 py-4">
            <div className="flex items-center gap-2 mb-3">
              <Link href="/" className="flex items-center gap-1 text-sm" style={{ color: textMuted }}><Home className="w-4 h-4" /> Inicio</Link>
              <ChevronRight className="w-4 h-4" style={{ color: textMuted }} />
              <span className="text-sm font-medium" style={{ color: accentPrimary }}>Segments</span>
            </div>
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold" style={{ color: textPrimary }}>Segments</h1>
                <p className="text-sm" style={{ color: textMuted }}>
                  Find and reach the right audience with segments. Group users based on their behaviors, preferences, or past actions.
                </p>
              </div>
              <div className="flex items-center gap-3">
                <button className="px-4 py-2 rounded-lg text-sm" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor, color: textPrimary }}>
                  Take a tour
                </button>
                <Link href="/segments/builder" className="px-4 py-2 rounded-lg text-sm font-medium text-white flex items-center gap-2" style={{ backgroundColor: accentPrimary }}>
                  <Plus className="w-4 h-4" /> Create Segment
                </Link>
              </div>
            </div>
          </div>
        </header>

        <div className="p-6">
          {/* Filters */}
          <div className="flex items-center gap-4 mb-6">
            <select
              value={selectedTag}
              onChange={(e) => setSelectedTag(e.target.value) : []}
              className="px-4 py-2 rounded-lg text-sm"
              style={{ backgroundColor: bgCard, border: "1px solid " + borderColor, color: textPrimary }}
            >
              {allTags?.map(tag => <option key={tag} value={tag}>{tag}</option>) : []}
            </select>
            
            <button className="px-4 py-2 rounded-lg text-sm flex items-center gap-2" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor, color: textPrimary }}>
              <Filter className="w-4 h-4" /> Filters
            </button>
            
            <button className="px-4 py-2 rounded-lg text-sm flex items-center gap-2" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor, color: textPrimary }}>
              Columns
            </button>
            
            <label className="flex items-center gap-2 text-sm cursor-pointer" style={{ color: textMuted }}>
              <input type="checkbox" checked={showStarredOnly} onChange={(e) => setShowStarredOnly(e.target.checked) : []} className="rounded" />
              Show starred only
            </label>

            <div className="flex-1" />
            
            <div className="relative">
              <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style={{ color: textMuted }} />
              <input
                type="text"
                placeholder="Search for segments"
                value={search}
                onChange={(e) => setSearch(e.target.value) : []}
                className="pl-10 pr-4 py-2 rounded-lg text-sm w-64"
                style={{ backgroundColor: bgCard, border: "1px solid " + borderColor, color: textPrimary }}
              />
            </div>
          </div>

          {/* Results count */}
          <p className="text-sm mb-4" style={{ color: textMuted }}>{filteredSegments.length} Results</p>

          {/* Table */}
          <div className="rounded-xl overflow-hidden" style={{ backgroundColor: bgCard, border: "1px solid " + borderColor }}>
            <table className="w-full">
              <thead>
                <tr style={{ borderBottom: "1px solid " + borderColor }}>
                  <th className="w-10 p-4"><input type="checkbox" className="rounded" /></th>
                  <th className="w-10 p-4"></th>
                  <th className="text-left p-4 text-sm font-medium" style={{ color: textMuted }}>Segment name</th>
                  <th className="text-left p-4 text-sm font-medium" style={{ color: textMuted }}>Users</th>
                  <th className="text-left p-4 text-sm font-medium" style={{ color: textMuted }}>Status</th>
                  <th className="text-left p-4 text-sm font-medium" style={{ color: textMuted }}>Last edited by</th>
                  <th className="text-left p-4 text-sm font-medium" style={{ color: textMuted }}>Last edited</th>
                  <th className="w-10 p-4"></th>
                </tr>
              </thead>
              <tbody>
                {filteredSegments?.map((segment) => (
                  <tr key={segment.id} className="hover:bg-white/5 transition-colors" style={{ borderBottom: "1px solid " + borderColor }}>
                    <td className="p-4"><input type="checkbox" className="rounded" /></td>
                    <td className="p-4">
                      <button onClick={() => toggleStar(segment.id) : []} className="text-amber-400 hover:text-amber-300">
                        {segment.starred ? <Star className="w-4 h-4 fill-current" /> : <StarOff className="w-4 h-4" />}
                      </button>
                    </td>
                    <td className="p-4">
                      <Link href={`/segments/builder?id=${segment.id}`} className="font-medium hover:underline" style={{ color: accentPrimary }}>
                        {segment.name}
                      </Link>
                      <div className="flex items-center gap-2 mt-1">
                        {segment?.tags?.map(tag => (
                          <span key={tag} className="px-2 py-0.5 rounded-full text-xs" style={{ backgroundColor: accentPrimary + "20", color: accentPrimary }}>
                            {tag}
                          </span>
                        )) : []}
                      </div>
                    </td>
                    <td className="p-4">
                      <span className="font-medium" style={{ color: textPrimary }}>{segment.userCount.toLocaleString() : []}</span>
                      <span className="text-xs ml-1" style={{ color: textMuted }}>({segment.percentage}%)</span>
                    </td>
                    <td className="p-4">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${segment.status === "active" ? "bg-green-500/20 text-green-500" : segment.status === "draft" ? "bg-gray-500/20 text-gray-400" : "bg-red-500/20 text-red-500"}`}>
                        {segment.status.charAt(0).toUpperCase() + segment.status.slice(1) : []}
                      </span>
                    </td>
                    <td className="p-4 text-sm" style={{ color: textMuted }}>{segment.lastEditedBy}</td>
                    <td className="p-4 text-sm" style={{ color: textMuted }}>{segment.lastEdited}</td>
                    <td className="p-4">
                      <button className="p-2 rounded-lg hover:bg-white/10" style={{ color: textMuted }}>
                        <MoreHorizontal className="w-4 h-4" />
                      </button>
                    </td>
                  </tr>
                )) : []}
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  );
}


